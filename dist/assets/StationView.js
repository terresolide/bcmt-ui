import{_ as K,u as Q,r as W,a as X,c as U,o as Y,b as _,d as ee,w as L,e as d,f as i,g as te,h as ne,i as y,j as v,v as N,k as ae,l as $,F as k,m as h,n as re,p as w,t as m,q as ie,s as o,x as se}from"./index.js";import{_ as le}from"./FileComponent.js";const oe={style:{background:"rgba(0,0,0,0.2)",margin:"0",padding:"10px"}},de={class:"station-form",style:{margin:"10px 0"}},pe={key:0},ue=["value"],fe=["value"],ve={key:1},ge=["value"],be=["value"],ye={class:"paging"},me={key:0,class:"header-file"},xe={key:1,style:{"text-align":"center",margin:"20px"}},Te={__name:"StationView",setup(qe){const g=Q().state.api,p=_(),j=ie(),e=W({id:null,group:null,feature:null,total:null,files:[],sensor:"",sensors:[],dataType:"",dataTypes:{},observedProperty:"",observedProperties:[],frequency:"",frequencies:{},start:"",end:"",sampling:"",samplings:[],paging:{offset:0,nb:30},lastIndex:[0]}),q=X(null),S=U(()=>e.paging.offset+1),I=U(()=>e.paging.offset+e.files.length);window.addEventListener("resize",C);function C(){if(q&&q.value){var n=q.value.getBoundingClientRect();q.value.style.maxHeight=window.innerHeight-n.y-30+"px"}}function B(){e.id=null,e.group=null,e.feature=null,e.total=null,e.files=[],e.sensors=[],e.observedProperties=[],e.samplings=[]}function V(){B(),e.id=p.params.id?p.params.id:null;var n="int";if(isNaN(parseInt(e.id))){n="string";var t=g+"/Things?$filter=name eq '"+e.id.toUpperCase()+"'&$expand=Locations($top=1)"}else var t=g+"/Things("+e.id+")?$expand=Locations($top=1)";fetch(t).then(a=>a.ok?a.json():{error:a.status+" - "+a.statusText}).then(a=>{n==="string"&&(a.value.length===0||(a=a.value[0],e.id=a["@iot.id"]));var r="bcmt",s=a.properties.Intermagnet||a.properties.intermagnet;if(s&&s==="true"&&(r="intermagnet"),a.properties.Type==="Observatory"||a.properties.type==="Observatory"?r+="Observatory":r+="Station",a.Locations[0].location.type==="Feature")var l=a.Locations[0].location;else{var l={type:"Feature"};l.geometry=a.Locations[0].location}l.id=a["@iot.id"],l.properties=a.properties,l.properties.name=a.name,l.properties.description=a.description,e.group=r,e.feature=l,Promise.all([E(),z(),F()]).then(T=>{C(),D()}).catch(T=>{console.log(T)})})}function E(){return new Promise((n,t)=>{var a=g+"/Sensors?$expand=Datastreams($top=1;$expand=Thing($filter=id eq "+e.id+"))",a=g+"/Sensors?$filter=Datastreams/Thing/@iot.id eq "+e.id;fetch(a).then(r=>r.ok?r.json():(t(),{error:r.status+" - "+r.statusText})).then(r=>{r.value&&(e.sensors=r.value,n(!0))})})}function z(){return new Promise((n,t)=>{var a=g+"/Datastreams?$select=distinct:properties/samplingPeriod&$filter=Thing/@iot.id eq ("+e.id+")";fetch(a).then(r=>r.json(),r=>r).then(r=>{r.value.forEach(function(s){e.samplings.push(s.properties.samplingPeriod)}),n(!0)})})}function F(){return new Promise((n,t)=>{var a=g+"/ObservedProperties?$select=id,name&$filter=Datastreams/Thing/@iot.id eq "+e.id;fetch(a).then(r=>r.ok?r.json():{error:r.status+" - "+r.statusText}).then(r=>{if(r.value){e.observedProperties=r.value;var s=["variation","quasidefinitive","definitive"];e.dataTypes={},e.observedProperties.forEach(function(l,T){for(var c in s){var f=s[c];if(e.observedProperties[T].order=3-c,l.name.indexOf(f)>=0){e.dataTypes[f]||(e.dataTypes[f]={value:f,name:f,list:[]});var u=l.name.replace(f,"");l.frequency=u,e.dataTypes[f].list.push(l),e.frequencies[u]||(e.frequencies[u]=[]),e.frequencies[u].push(l["@iot.id"]);break}}}),console.log(e.frequencies),n(!0)}})})}function D(){var n=g+"/Things("+e.id+")/Datastreams?";n+="$skip="+(e.available?e.lastIndex[e.lastIndex.length-1]:e.paging.offset)+"&$top="+e.paging.nb*(e.available?3:1)+"&$count=true&$expand=ObservedProperty($select=@iot.id)&$orderBy=name desc";var t=[];if(!e.available&&e.dataType){if(e.observedProperty){var a=e.dataTypes[e.dataType].list.find(s=>s.frequency===e.observedProperty);a?t.push("ObservedProperty/@iot.id eq "+a["@iot.id"]):e.observedProperty=""}else if(e.dataTypes[e.dataType]){var r=e.dataTypes[e.dataType].list.map(s=>"ObservedProperty/@iot.id eq "+s["@iot.id"]);r.length>0&&t.push("("+r.join(" or ")+")")}}else if(e.available&&e.frequency){var r=e.frequencies[e.frequency].map(l=>"ObservedProperty/@iot.id eq "+l);t.push("("+r.join(" or ")+")")}e.start&&t.push("properties/end ge '"+e.start+"T00:00:00Z'"),e.end&&t.push("properties/start le '"+e.end+"T23:59:59Z'"),e.sensor&&t.push("Sensor/@iot.id eq "+e.sensor),e.sampling&&t.push("properties/samplingPeriod eq '"+e.sampling+"'"),t.length>0&&(n+="&$filter="+t.join(" and ")),fetch(n).then(s=>s.ok?s.json():{error:s.status+" - "+s.statusText}).then(s=>{if(s.value)if(e.available){var l={},T=/^[a-z]{3}([0-9]{8})[^\.]*\.([a-z]+)$/;s.value.forEach(u=>{var P=u.name.match(T);if(P){var G=e.observedProperties.find(J=>J["@iot.id"]===u.ObservedProperty["@iot.id"]);u.order=G.order;var O=P[1]+P[2];l[O]?l[O].push(u):l[O]=[u]}});var c=0;e.files=[];for(var f in l)if(c+=l[f].length,l[f].sort(function(u,P){return u.order<P.order?-1:1}),e.files.push(l[f][0]),e.files.length===e.paging.nb){e.lastIndex.push(e.lastIndex[e.lastIndex.length-1]+c);break}}else e.files=s.value;s["@iot.count"]&&(e.total=s["@iot.count"])})}function M(){var n=Object.assign({},p.query);n.index=I.value+1,n.nb=e.paging.nb,x(n)}function R(){var n=Object.assign({},p.query),t=S.value-e.paging.nb;n.index=t>0?t:1,n.nb=e.paging.nb,e.available&&(e.lastIndex.length>2?(e.lastIndex.pop(),e.lastIndex.pop()):e.lastIndex=[0]),x(n)}function H(){var n=Object.assign({},p.query),t=Math.floor(e.total/e.paging.nb)+(e.total%e.paging.nb===0?1:0);n.index=t*e.paging.nb+1,n.nb=e.paging.nb,x(n)}function Z(){var n=Object.assign({},p.query);n.index=1,e.lastIndex=[0],n.nb=e.paging.nb,x(n)}function x(n){j.push({name:p.name,params:p.params,query:n})}function A(){var n=Object.assign({},p.query);n.nb=e.paging.nb,x(n)}function b(n){var t=Object.assign({},p.query);switch(n){case"start":e.start==""?delete t.start:t.start=e.start;break;case"end":e.end==""?delete t.end:t.end=e.end;break;case"dataType":if(e.dataType==="")delete t.type,delete t.op;else if(t.type=e.dataType,e.observedProperty!==""){var a=e.dataTypes[e.dataType].list.find(s=>s.frequency===e.observedProperty);a?t.op=a.frequency:delete t.op}break;case"observed":if(e.observedProperty!==""){var r=e.dataTypes[e.dataType].list.find(s=>s.frequency===e.observedProperty);r?t.op=r.frequency:delete t.op}else e.observedProperty="",delete t.op;break;case"frequency":e.frequency===""?delete t.frequency:t.frequency=e.frequency,e.lastIndex=[0],t.index=1;break;case"sampling":e.sampling?t.sampling=e.sampling:delete t.sampling;break;case"available":if(e.lastIndex=[0],t.index=1,e.available)delete t.type,delete t.op,t.available=e.available,e.frequency&&(t.frequency=e.frequency);else if(delete t.available,delete t.frequency,e.dataType&&(t.type=e.dataType),e.observedProperty){var r=e.dataTypes[e.dataType].list.find(l=>l.frequency===e.observedProperty);r?t.op=r.frequency:delete t.op}break;case"sensor":e.sensor?t.sensor=e.sensor:delete t.sensor;break}x(t)}return Y(()=>{var n=p.query;n.nb&&(e.paging.nb=parseInt(n.nb)),n.index&&(e.paging.offset=parseInt(n.index)-1),n.type&&(e.dataType=n.type),n.op&&(e.observedProperty=n.op),n.sampling&&(e.sampling=n.sampling),n.frequency&&(e.frequency=n.frequency),n.available&&(e.available=!0),n.start&&(e.start=n.start),n.end&&(e.end=n.end),V()}),ee(()=>{window.removeEventListener("resize",C)}),L(()=>p.params.id,n=>{V()}),L(()=>p.query,n=>{n.nb&&(e.paging.nb=parseInt(n.nb)),n.index&&(e.paging.offset=parseInt(n.index)-1),n.type&&(e.dataType=n.type),n.op&&(e.observedProperty=n.op),n.sensor&&(e.sensor=n.sensor),n.start&&(e.start=n.start),n.end&&(e.end=n.end),n.frequency&&(e.frequency=n.frequency),n.available&&(e.available=!0),D()}),(n,t)=>(o(),d("div",oe,[i("div",{class:w(["station-page",e.group])},[te(ne,{group:e.group,feature:e.feature,mode:"page"},null,8,["group","feature"]),i("div",de,[i("div",null,[t[15]||(t[15]=i("label",{style:{width:"60px",display:"inline-block"}},"Start",-1)),t[16]||(t[16]=y()),v(i("input",{type:"date","onUpdate:modelValue":t[0]||(t[0]=a=>e.start=a),onChange:t[1]||(t[1]=a=>b("start"))},null,544),[[N,e.start]])]),e.available?(o(),d("div",ve,[t[21]||(t[21]=i("label",{style:{width:"150px",display:"inline-block"}},"Frequency",-1)),v(i("select",{"onUpdate:modelValue":t[6]||(t[6]=a=>e.frequency=a),onChange:t[7]||(t[7]=a=>b("frequency"))},[t[20]||(t[20]=i("option",{value:""},"---",-1)),(o(!0),d(k,null,h(e.frequencies,(a,r)=>(o(),d("option",{value:r},m(r),9,ge))),256))],544),[[$,e.frequency]])])):(o(),d("div",pe,[t[19]||(t[19]=i("label",{style:{width:"150px",display:"inline-block"}},"Data type ",-1)),v(i("select",{"onUpdate:modelValue":t[2]||(t[2]=a=>e.dataType=a),onChange:t[3]||(t[3]=a=>b("dataType"))},[t[17]||(t[17]=i("option",{value:""},"---",-1)),(o(!0),d(k,null,h(e.dataTypes,a=>(o(),d("option",{value:a.value},m(a.name),9,ue))),256))],544),[[$,e.dataType]]),e.dataType&&e.dataTypes[e.dataType]?v((o(),d("select",{key:0,"onUpdate:modelValue":t[4]||(t[4]=a=>e.observedProperty=a),onChange:t[5]||(t[5]=a=>b("observed"))},[t[18]||(t[18]=i("option",{value:""},"---",-1)),(o(!0),d(k,null,h(e.dataTypes[e.dataType].list,a=>(o(),d("option",{value:a.frequency},m(a.frequency),9,fe))),256))],544)),[[$,e.observedProperty]]):ae("",!0)])),i("div",null,[t[22]||(t[22]=i("label",null,"Show best available",-1)),t[23]||(t[23]=y()),v(i("input",{type:"checkbox","onUpdate:modelValue":t[8]||(t[8]=a=>e.available=a),onChange:t[9]||(t[9]=a=>b("available"))},null,544),[[re,e.available]])]),i("div",null,[t[24]||(t[24]=i("label",{style:{width:"60px",display:"inline-block"}},"End",-1)),t[25]||(t[25]=y()),v(i("input",{type:"date","onUpdate:modelValue":t[10]||(t[10]=a=>e.end=a),onChange:t[11]||(t[11]=a=>b("end"))},null,544),[[N,e.end]])]),i("div",null,[t[27]||(t[27]=i("label",{style:{width:"150px",display:"inline-block"}},"Sampling period ",-1)),v(i("select",{"onUpdate:modelValue":t[12]||(t[12]=a=>e.sampling=a),onChange:t[13]||(t[13]=a=>b("sampling"))},[t[26]||(t[26]=i("option",{value:""},"---",-1)),(o(!0),d(k,null,h(e.samplings,a=>(o(),d("option",{value:a},m(a),9,be))),256))],544),[[$,e.sampling]])])]),i("div",ye,[i("span",{class:w(["bcmt-button",{disabled:e.paging.offset===0}]),onClick:Z},"«",2),i("span",{class:w(["bcmt-button",{disabled:e.paging.offset===0}]),onClick:R},"‹",2),t[29]||(t[29]=y(" Results: ")),i("b",null,m(S.value),1),t[30]||(t[30]=y(" to ")),i("b",null,m(I.value),1),y(" among "+m(e.total)+"   (",1),v(i("select",{"onUpdate:modelValue":t[14]||(t[14]=a=>e.paging.nb=a),onChange:A},t[28]||(t[28]=[i("option",{value:"30"},"30 per page",-1),i("option",{value:"100"},"100 per page",-1)]),544),[[$,e.paging.nb]]),t[31]||(t[31]=y(")   ")),i("span",{class:w(["bcmt-button",{disabled:I.value>=e.total}]),onClick:M},"›",2),i("span",{class:w(["bcmt-button",{disabled:I.value>=e.total||e.available}]),onClick:H},"»",2)]),e.files.length>0?(o(),d("div",me,t[32]||(t[32]=[i("div",null,"Download / Draw",-1),i("div",null,"Analysis Centre",-1),i("div",null,"DOI",-1),i("div",null,"Sampling period",-1),i("div",null,"License",-1)]))):(o(),d("div",xe,t[33]||(t[33]=[i("em",null,"No file found",-1)]))),i("div",{ref_key:"filesNode",ref:q,style:{"overflow-y":"scroll"}},[(o(!0),d(k,null,h(e.files,a=>(o(),se(le,{file:a,group:e.group},null,8,["file","group"]))),256))],512)],2)]))}},ke=K(Te,[["__scopeId","data-v-fdb4fc4f"]]);export{ke as default};

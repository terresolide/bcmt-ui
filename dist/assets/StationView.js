import{_ as A,u as G,r as J,a as K,c as D,o as Q,b as W,d as X,w as L,e as d,f as r,g as Y,h as Z,i as g,j as y,v as N,k as _,l as $,F as w,m as k,n as ee,p as q,t as c,q as te,s as u,x as ne}from"./index.js";import{_ as ae}from"./FileComponent.js";const re={style:{background:"rgba(0,0,0,0.2)",margin:"0",padding:"10px"}},ie={class:"station-form",style:{margin:"10px 0"}},se=["value"],oe=["value"],le=["value"],pe={class:"paging"},ue={key:0,class:"header-file"},de={key:1,style:{"text-align":"center",margin:"20px"}},fe={__name:"StationView",setup(ve){const v=G().state.api,l=W(),U=te(),e=J({id:null,group:null,feature:null,total:null,files:[],sensor:"",sensors:[],dataType:"",dataTypes:{},observedProperty:"",observedProperties:[],frequency:"",frequencies:[],paging:{offset:0,nb:30}}),T=K(null),S=D(()=>e.paging.offset+1),x=D(()=>e.paging.offset+e.files.length);window.addEventListener("resize",h);function h(){if(T&&T.value){var n=T.value.getBoundingClientRect();T.value.style.maxHeight=window.innerHeight-n.y-30+"px"}}function B(){e.id=null,e.group=null,e.feature=null,e.total=null,e.files=[],e.sensors=[],e.observedProperties=[],e.frequencies=[]}function O(){B(),e.id=l.params.id?l.params.id:null;var n="int";if(isNaN(parseInt(e.id))){n="string";var t=v+"/Things?$filter=name eq '"+e.id.toUpperCase()+"'&$expand=Locations($top=1)"}else var t=v+"/Things("+e.id+")?$expand=Locations($top=1)";fetch(t).then(a=>a.ok?a.json():{error:a.status+" - "+a.statusText}).then(a=>{n==="string"&&(a.value.length===0||(a=a.value[0],e.id=a["@iot.id"]));var i="bcmt",s=a.properties.Intermagnet||a.properties.intermagnet;if(s&&s==="true"&&(i="intermagnet"),a.properties.Type==="Observatory"||a.properties.type==="Observatory"?i+="Observatory":i+="Station",a.Locations[0].location.type==="Feature")var o=a.Locations[0].location;else{var o={type:"Feature"};o.geometry=a.Locations[0].location}o.id=a["@iot.id"],o.properties=a.properties,o.properties.name=a.name,o.properties.description=a.description,e.group=i,e.feature=o,Promise.all([I(),j(),E()]).then(f=>{h(),V()}).catch(f=>{console.log(f)})})}function I(){return new Promise((n,t)=>{var a=v+"/Sensors?$expand=Datastreams($top=1;$expand=Thing($filter=id eq "+e.id+"))",a=v+"/Sensors?$filter=Datastreams/Thing/@iot.id eq "+e.id;fetch(a).then(i=>i.ok?i.json():(t(),{error:i.status+" - "+i.statusText})).then(i=>{i.value&&(e.sensors=i.value,n(!0))})})}function j(){return new Promise((n,t)=>{var a=v+"/Datastreams?$select=distinct:properties/samplingPeriod&$filter=Thing/@iot.id eq ("+e.id+")";fetch(a).then(i=>i.json(),i=>i).then(i=>{i.value.forEach(function(s){e.frequencies.push(s.properties.samplingPeriod)}),n(!0)})})}function E(){return new Promise((n,t)=>{var a=v+"/ObservedProperties?$filter=Datastreams/Thing/@iot.id eq "+e.id;fetch(a).then(i=>i.ok?i.json():{error:i.status+" - "+i.statusText}).then(i=>{if(i.value){var s=i.value,o=["variation","quasidefinitive","definitive"];e.dataTypes={},s.forEach(function(f){for(var m in o){var p=o[m];if(f.name.indexOf(p)>=0){e.dataTypes[p]||(e.dataTypes[p]={value:p,name:p,list:[]}),f.frequency=f.name.replace(p,""),e.dataTypes[p].list.push(f);break}}}),n(!0)}})})}function V(){var n=v+"/Things("+e.id+")/Datastreams?";n+="$skip="+e.paging.offset+"&$top="+e.paging.nb+"&$count=true&$expand=Sensor&$orderBy=name desc";var t=[];if(e.dataType){if(e.observedProperty){var a=e.dataTypes[e.dataType].list.find(s=>s.frequency===e.observedProperty);a?t.push("ObservedProperty/@iot.id eq "+a["@iot.id"]):e.observedProperty=""}else if(e.dataTypes[e.dataType]){var i=e.dataTypes[e.dataType].list.map(s=>"ObservedProperty/@iot.id eq "+s["@iot.id"]);i.length>0&&t.push("("+i.join(" or ")+")")}}e.sensor&&t.push("Sensor/@iot.id eq "+e.sensor),e.frequency&&t.push("properties/samplingPeriod eq '"+e.frequency+"'"),t.length>0&&(n+="&$filter="+t.join(" and ")),fetch(n).then(s=>s.ok?s.json():{error:s.status+" - "+s.statusText}).then(s=>{if(s.value)if(e.available){var o={},f=/^[a-z]{3}([0-9]{8})[^\.]*\.([a-z]+)$/;s.value.forEach(m=>{console.log(m.name);var p=m.name.match(f);if(p){var C=p[1]+p[2];o[C]?o[C].push(m):o[C]=[m]}console.log(p)})}else e.files=s.value;s["@iot.count"]&&(e.total=s["@iot.count"])})}function z(){var n=Object.assign({},l.query);n.index=x.value+1,n.nb=e.paging.nb,b(n)}function F(){var n=Object.assign({},l.query),t=S.value-e.paging.nb;n.index=t>0?t:1,n.nb=e.paging.nb,b(n)}function M(){var n=Object.assign({},l.query),t=Math.floor(e.total/e.paging.nb)+(e.total%e.paging.nb===0?1:0);n.index=t*e.paging.nb+1,n.nb=e.paging.nb,b(n)}function R(){var n=Object.assign({},l.query);n.index=1,n.nb=e.paging.nb,b(n)}function b(n){U.push({name:l.name,params:l.params,query:n})}function H(){var n=Object.assign({},l.query);n.nb=e.paging.nb,b(n)}function P(n){var t=Object.assign({},l.query);switch(n){case"dataType":if(e.dataType==="")delete t.type,delete t.op;else if(t.type=e.dataType,e.observedProperty!==""){var a=e.dataTypes[e.dataType].list.find(s=>s.frequency===e.observedProperty);a?t.op=a.frequency:delete t.op}break;case"observed":if(e.observedProperty!==""){var i=e.dataTypes[e.dataType].list.find(s=>s.frequency===e.observedProperty);i?t.op=i.frequency:delete t.op}else e.observedProperty="",delete t.op;break;case"frequency":e.frequency?t.sampling=e.frequency:delete t.sampling;break;case"available":e.available?t.available=e.available:delete t.available;case"sensor":e.sensor?t.sensor=e.sensor:delete t.sensor;break}b(t)}return Q(()=>{var n=l.query;n.nb&&(e.paging.nb=parseInt(n.nb)),n.index&&(e.paging.offset=parseInt(n.index)-1),n.type&&(e.dataType=n.type),n.op&&(e.observedProperty=n.op),n.sampling&&(e.frequency=n.sampling),n.available&&(e.available=!0),O()}),X(()=>{window.removeEventListener("resize",h)}),L(()=>l.params.id,n=>{O()}),L(()=>l.query,n=>{n.nb&&(e.paging.nb=parseInt(n.nb)),n.index&&(e.paging.offset=parseInt(n.index)-1),n.type&&(e.dataType=n.type),n.op&&(e.observedProperty=n.op),n.sensor&&(e.sensor=n.sensor),V()}),(n,t)=>(u(),d("div",re,[r("div",{class:q(["station-page",e.group])},[Y(Z,{group:e.group,feature:e.feature,mode:"page"},null,8,["group","feature"]),r("div",ie,[r("div",null,[t[11]||(t[11]=r("label",{style:{width:"60px",display:"inline-block"}},"Start",-1)),t[12]||(t[12]=g()),y(r("input",{type:"date","onUpdate:modelValue":t[0]||(t[0]=a=>e.start=a)},null,512),[[N,e.start]])]),r("div",null,[t[15]||(t[15]=r("label",{style:{width:"150px",display:"inline-block"}},"Data type ",-1)),y(r("select",{"onUpdate:modelValue":t[1]||(t[1]=a=>e.dataType=a),onChange:t[2]||(t[2]=a=>P("dataType"))},[t[13]||(t[13]=r("option",{value:""},"---",-1)),(u(!0),d(w,null,k(e.dataTypes,a=>(u(),d("option",{value:a.value},c(a.name),9,se))),256))],544),[[$,e.dataType]]),e.dataType&&e.dataTypes[e.dataType]?y((u(),d("select",{key:0,"onUpdate:modelValue":t[3]||(t[3]=a=>e.observedProperty=a),onChange:t[4]||(t[4]=a=>P("observed"))},[t[14]||(t[14]=r("option",{value:""},"---",-1)),(u(!0),d(w,null,k(e.dataTypes[e.dataType].list,a=>(u(),d("option",{value:a.frequency},c(a.frequency),9,oe))),256))],544)),[[$,e.observedProperty]]):_("",!0)]),r("div",null,[t[16]||(t[16]=r("label",null,"Show most available",-1)),t[17]||(t[17]=g()),y(r("input",{type:"checkbox","onUpdate:modelValue":t[5]||(t[5]=a=>e.available=a),onChange:t[6]||(t[6]=a=>P("available"))},null,544),[[ee,e.available]])]),r("div",null,[t[18]||(t[18]=r("label",{style:{width:"60px",display:"inline-block"}},"End",-1)),t[19]||(t[19]=g()),y(r("input",{type:"date","onUpdate:modelValue":t[7]||(t[7]=a=>e.end=a)},null,512),[[N,e.end]])]),r("div",null,[t[21]||(t[21]=r("label",{style:{width:"150px",display:"inline-block"}},"Sampling period ",-1)),y(r("select",{"onUpdate:modelValue":t[8]||(t[8]=a=>e.frequency=a),onChange:t[9]||(t[9]=a=>P("frequency"))},[t[20]||(t[20]=r("option",{value:""},"---",-1)),(u(!0),d(w,null,k(e.frequencies,a=>(u(),d("option",{value:a},c(a),9,le))),256))],544),[[$,e.frequency]])])]),r("div",pe,[r("span",{class:q(["bcmt-button",{disabled:e.paging.offset===0}]),onClick:R},"«",2),r("span",{class:q(["bcmt-button",{disabled:e.paging.offset===0}]),onClick:F},"‹",2),t[23]||(t[23]=g(" Results: ")),r("b",null,c(S.value),1),t[24]||(t[24]=g(" to ")),r("b",null,c(x.value),1),g(" among "+c(e.total)+"   (",1),y(r("select",{"onUpdate:modelValue":t[10]||(t[10]=a=>e.paging.nb=a),onChange:H},t[22]||(t[22]=[r("option",{value:"30"},"30 per page",-1),r("option",{value:"100"},"100 per page",-1)]),544),[[$,e.paging.nb]]),t[25]||(t[25]=g(")   ")),r("span",{class:q(["bcmt-button",{disabled:x.value>=e.total}]),onClick:z},"›",2),r("span",{class:q(["bcmt-button",{disabled:x.value>=e.total}]),onClick:M},"»",2)]),e.files.length>0?(u(),d("div",ue,t[26]||(t[26]=[r("div",null,"Download / Draw",-1),r("div",null,"Analysis Centre",-1),r("div",null,"DOI",-1),r("div",null,"Sampling period",-1),r("div",null,"License",-1)]))):(u(),d("div",de,t[27]||(t[27]=[r("em",null,"No file found",-1)]))),r("div",{ref_key:"filesNode",ref:T,style:{"overflow-y":"scroll"}},[(u(!0),d(w,null,k(e.files,a=>(u(),ne(ae,{file:a,group:e.group},null,8,["file","group"]))),256))],512)],2)]))}},me=A(fe,[["__scopeId","data-v-aca309d2"]]);export{me as default};

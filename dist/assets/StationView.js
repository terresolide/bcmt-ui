import{_ as H,r as A,a as G,c as O,o as J,b as K,w as D,d as p,e as a,f as Q,g as W,h as y,i as b,v as V,j as x,F as P,k as $,l as X,n as T,t as m,u as Y,m as Z,p as l,q as _,s as ee}from"./index.js";import{_ as te}from"./FileComponent.js";const ne={style:{background:"rgba(0,0,0,0.2)",margin:"0",padding:"10px"}},re={class:"station-form",style:{margin:"10px 0"}},ae=["value"],ie=["value"],se=["value"],oe={class:"paging"},le={key:0,class:"header-file"},pe={key:1,style:{"text-align":"center",margin:"20px"}},ue={__name:"StationView",setup(de){const d=Y().state.api,o=Z(),L=ee(),e=A({id:null,group:null,feature:null,total:null,files:[],sensor:"",sensors:[],dataType:"",dataTypes:{},observedProperty:"",observedProperties:[],frequency:"",frequencies:[],paging:{offset:0,nb:30}}),c=G(null),h=O(()=>e.paging.offset+1),q=O(()=>e.paging.offset+e.files.length);window.addEventListener("resize",w);function w(){if(c&&c.value){var n=c.value.getBoundingClientRect();c.value.style.maxHeight=window.innerHeight-n.y-30+"px"}}function N(){e.id=null,e.group=null,e.feature=null,e.total=null,e.files=[],e.sensors=[],e.observedProperties=[],e.frequencies=[]}function S(){N(),e.id=o.params.id?o.params.id:null;var n="int";if(isNaN(parseInt(e.id))){n="string";var t=d+"/Things?$filter=name eq '"+e.id.toUpperCase()+"'&$expand=Locations($top=1)"}else var t=d+"/Things("+e.id+")?$expand=Locations($top=1)";fetch(t).then(r=>r.ok?r.json():{error:r.status+" - "+r.statusText}).then(r=>{n==="string"&&(r.value.length===0||(r=r.value[0],e.id=r["@iot.id"]));var i="bcmt",s=r.properties.Intermagnet||r.properties.intermagnet;if(s&&s==="true"&&(i="intermagnet"),r.properties.Type==="Observatory"||r.properties.type==="Observatory"?i+="Observatory":i+="Station",r.Locations[0].location.type==="Feature")var u=r.Locations[0].location;else{var u={type:"Feature"};u.geometry=r.Locations[0].location}u.id=r["@iot.id"],u.properties=r.properties,u.properties.name=r.name,u.properties.description=r.description,e.group=i,e.feature=u,Promise.all([j(),B(),I()]).then(f=>{w(),C()}).catch(f=>{console.log(f)})})}function j(){return new Promise((n,t)=>{var r=d+"/Sensors?$expand=Datastreams($top=1;$expand=Thing($filter=id eq "+e.id+"))",r=d+"/Sensors?$filter=Datastreams/Thing/@iot.id eq "+e.id;fetch(r).then(i=>i.ok?i.json():(t(),{error:i.status+" - "+i.statusText})).then(i=>{i.value&&(e.sensors=i.value,n(!0))})})}function B(){return new Promise((n,t)=>{var r=d+"/Datastreams?$select=distinct:properties/samplingPeriod&$filter=Thing/@iot.id eq ("+e.id+")";fetch(r).then(i=>i.json(),i=>i).then(i=>{i.value.forEach(function(s){e.frequencies.push(s.properties.samplingPeriod)}),n(!0)})})}function I(){return new Promise((n,t)=>{var r=d+"/ObservedProperties?$filter=Datastreams/Thing/@iot.id eq "+e.id;fetch(r).then(i=>i.ok?i.json():{error:i.status+" - "+i.statusText}).then(i=>{if(i.value){var s=i.value,u=["variation","quasidefinitive","definitive"];e.dataTypes={},s.forEach(function(f){for(var M in u){var g=u[M];if(f.name.indexOf(g)>=0){e.dataTypes[g]||(e.dataTypes[g]={value:g,name:g,list:[]}),f.frequency=f.name.replace(g,""),e.dataTypes[g].list.push(f);break}}}),n(!0)}})})}function C(){var n=d+"/Things("+e.id+")/Datastreams?";n+="$skip="+e.paging.offset+"&$top="+e.paging.nb+"&$count=true&$expand=Sensor&$orderBy=name desc";var t=[];if(e.dataType){if(e.observedProperty){var r=e.dataTypes[e.dataType].list.find(s=>s.frequency===e.observedProperty);r?t.push("ObservedProperty/@iot.id eq "+r["@iot.id"]):e.observedProperty=""}else if(e.dataTypes[e.dataType]){var i=e.dataTypes[e.dataType].list.map(s=>"ObservedProperty/@iot.id eq "+s["@iot.id"]);i.length>0&&t.push("("+i.join(" or ")+")")}}e.sensor&&t.push("Sensor/@iot.id eq "+e.sensor),e.frequency&&t.push("properties/samplingPeriod eq '"+e.frequency+"'"),t.length>0&&(n+="&$filter="+t.join(" and ")),fetch(n).then(s=>s.ok?s.json():{error:s.status+" - "+s.statusText}).then(s=>{s.value&&(e.files=s.value),s["@iot.count"]&&(e.total=s["@iot.count"])})}function U(){var n=Object.assign({},o.query);n.index=q.value+1,n.nb=e.paging.nb,v(n)}function E(){var n=Object.assign({},o.query),t=h.value-e.paging.nb;n.index=t>0?t:1,n.nb=e.paging.nb,v(n)}function F(){var n=Object.assign({},o.query),t=Math.floor(e.total/e.paging.nb)+(e.total%e.paging.nb===0?1:0);n.index=t*e.paging.nb+1,n.nb=e.paging.nb,v(n)}function R(){var n=Object.assign({},o.query);n.index=1,n.nb=e.paging.nb,v(n)}function v(n){L.push({name:o.name,params:o.params,query:n})}function z(){var n=Object.assign({},o.query);n.nb=e.paging.nb,v(n)}function k(n){var t=Object.assign({},o.query);switch(n){case"dataType":if(e.dataType==="")delete t.type,delete t.op;else if(t.type=e.dataType,e.observedProperty!==""){var r=e.dataTypes[e.dataType].list.find(s=>s.frequency===e.observedProperty);r?t.op=r.frequency:delete t.op}break;case"observed":if(e.observedProperty!==""){var i=e.dataTypes[e.dataType].list.find(s=>s.frequency===e.observedProperty);i?t.op=i.frequency:delete t.op}else e.observedProperty="",delete t.op;break;case"frequency":e.frequency?t.sampling=e.frequency:delete t.sampling;break;case"sensor":e.sensor?t.sensor=e.sensor:delete t.sensor;break}v(t)}return J(()=>{var n=o.query;n.nb&&(e.paging.nb=parseInt(n.nb)),n.index&&(e.paging.offset=parseInt(n.index)-1),n.type&&(e.dataType=n.type),n.op&&(e.observedProperty=n.op),n.sampling&&(e.frequency=n.sampling),S()}),K(()=>{window.removeEventListener("resize",w)}),D(()=>o.params.id,n=>{S()}),D(()=>o.query,n=>{n.nb&&(e.paging.nb=parseInt(n.nb)),n.index&&(e.paging.offset=parseInt(n.index)-1),n.type&&(e.dataType=n.type),n.op&&(e.observedProperty=n.op),n.sensor&&(e.sensor=n.sensor),C()}),(n,t)=>(l(),p("div",ne,[a("div",{class:T(["station-page",e.group])},[Q(W,{group:e.group,feature:e.feature,mode:"page"},null,8,["group","feature"]),a("div",re,[a("div",null,[t[9]||(t[9]=a("label",{style:{width:"60px",display:"inline-block"}},"Start",-1)),t[10]||(t[10]=y()),b(a("input",{type:"date","onUpdate:modelValue":t[0]||(t[0]=r=>e.start=r)},null,512),[[V,e.start]])]),a("div",null,[t[13]||(t[13]=a("label",{style:{width:"150px",display:"inline-block"}},"Data type ",-1)),b(a("select",{"onUpdate:modelValue":t[1]||(t[1]=r=>e.dataType=r),onChange:t[2]||(t[2]=r=>k("dataType"))},[t[11]||(t[11]=a("option",{value:""},"---",-1)),(l(!0),p(P,null,$(e.dataTypes,r=>(l(),p("option",{value:r.value},m(r.name),9,ae))),256))],544),[[x,e.dataType]]),e.dataType&&e.dataTypes[e.dataType]?b((l(),p("select",{key:0,"onUpdate:modelValue":t[3]||(t[3]=r=>e.observedProperty=r),onChange:t[4]||(t[4]=r=>k("observed"))},[t[12]||(t[12]=a("option",{value:""},"---",-1)),(l(!0),p(P,null,$(e.dataTypes[e.dataType].list,r=>(l(),p("option",{value:r.frequency},m(r.frequency),9,ie))),256))],544)),[[x,e.observedProperty]]):X("",!0)]),a("div",null,[t[14]||(t[14]=a("label",{style:{width:"60px",display:"inline-block"}},"End",-1)),t[15]||(t[15]=y()),b(a("input",{type:"date","onUpdate:modelValue":t[5]||(t[5]=r=>e.end=r)},null,512),[[V,e.end]])]),a("div",null,[t[17]||(t[17]=a("label",{style:{width:"150px",display:"inline-block"}},"Sampling period ",-1)),b(a("select",{"onUpdate:modelValue":t[6]||(t[6]=r=>e.frequency=r),onChange:t[7]||(t[7]=r=>k("frequency"))},[t[16]||(t[16]=a("option",{value:""},"---",-1)),(l(!0),p(P,null,$(e.frequencies,r=>(l(),p("option",{value:r},m(r),9,se))),256))],544),[[x,e.frequency]])])]),a("div",oe,[a("span",{class:T(["bcmt-button",{disabled:e.paging.offset===0}]),onClick:R},"«",2),a("span",{class:T(["bcmt-button",{disabled:e.paging.offset===0}]),onClick:E},"‹",2),t[19]||(t[19]=y(" Results: ")),a("b",null,m(h.value),1),t[20]||(t[20]=y(" to ")),a("b",null,m(q.value),1),y(" among "+m(e.total)+"   (",1),b(a("select",{"onUpdate:modelValue":t[8]||(t[8]=r=>e.paging.nb=r),onChange:z},t[18]||(t[18]=[a("option",{value:"30"},"30 per page",-1),a("option",{value:"100"},"100 per page",-1)]),544),[[x,e.paging.nb]]),t[21]||(t[21]=y(")   ")),a("span",{class:T(["bcmt-button",{disabled:q.value>=e.total}]),onClick:U},"›",2),a("span",{class:T(["bcmt-button",{disabled:q.value>=e.total}]),onClick:F},"»",2)]),e.files.length>0?(l(),p("div",le,t[22]||(t[22]=[a("div",null,"Download / Draw",-1),a("div",null,"Analysis Centre",-1),a("div",null,"DOI",-1),a("div",null,"Sampling period",-1),a("div",null,"License",-1)]))):(l(),p("div",pe,t[23]||(t[23]=[a("em",null,"No file found",-1)]))),a("div",{ref_key:"filesNode",ref:c,style:{"overflow-y":"scroll"}},[(l(!0),p(P,null,$(e.files,r=>(l(),_(te,{file:r,group:e.group},null,8,["file","group"]))),256))],512)],2)]))}},ye=H(ue,[["__scopeId","data-v-200f7aad"]]);export{ye as default};
